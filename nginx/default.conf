http {
    # This map is a dynamic way to set the Connection header correctly
    map $http_connection $connection_upgrade {
        "~*Upgrade" $http_connection;
        default keep-alive;
    }

    server {
        listen 80;

        # General location for other app traffic (if any)
        location / {
            proxy_pass http://challengecrf.api:5200/;
            proxy_set_header Host $host;
            # ... other standard proxy settings
        }

        # Specific location block for the SignalR Hub
        location /brokerhub {
            proxy_pass http://challengecrf.api:5200/brokerhub;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            
            # Optional: Disable proxy buffering for potential performance improvement with streaming
            proxy_buffering off;
        }
    }
}